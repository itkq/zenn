---
title: "Sentry Relay ã‚’æ´»ç”¨ã™ã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["sentry"]
published: false
---

ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ã® Sentry ã¯çŸ¥ååº¦ã‚‚é«˜ãã€Web ã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹ç”¨ã™ã‚‹ä¸Šã§æ´»ç”¨ã—ã¦ã„ã‚‹äººãŒå¤šã„ã§ã—ã‚‡ã†ã€‚æœ¬è¨˜äº‹ã§ã¯ Sentry å…¬å¼ãŒé–‹ç™ºã—ã¦ã„ã‚‹ [Relay](https://docs.sentry.io/product/relay/) ã¨ã„ã†ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

# Relay ã®æ¦‚è¦
Relay ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ Sentry ã‚µãƒ¼ãƒã®ä¸­é–“ã«é…ç½®ã™ã‚‹ã€ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒã§ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã¨ã—ã¦ Sentry ã‚’åˆ©ç”¨ã™ã‚‹éš›ã€ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹å…ˆã§ã‚ã‚‹ [DSN](https://docs.sentry.io/product/sentry-basics/dsn-explainer/) ã‚’è¨­å®šã—ã¾ã™ã€‚Relay ã‚’æŒŸã‚€éš›ã¯ã€DSN ã®ãƒ›ã‚¹ãƒˆãŒ Relay ã®ãã‚Œã«ãªã‚Šã¾ã™ã€‚https://github.com/getsentry/relay ã«ã¦ Apache License 2.0 ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

# 4 ã¤ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

1 ã€œ 3 ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã‚‚ã®ã§ã€4 ã¯å€‹äººçš„ã«ä½¿ãˆãã†ãªã‚‚ã®ã‚’æŒ™ã’ã¦ã„ã¾ã™ã€‚

## 1. å€‹äººæƒ…å ±ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

ç‰¹ã« SaaS ã§ã‚ã‚‹ sentry.io ã‚’ä½¿ã†å ´åˆã€ã‚¨ãƒ©ãƒ¼æƒ…å ±ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã®å€‹äººæƒ…å ±ãŒè¼‰ã‚‰ãªã„ã‚ˆã†ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å€‹äººæƒ…å ±ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹æ–¹æ³•ã¯ 3 ã¤ã‚ã‚Šã¾ã™ã€‚

1. [SDK](https://docs.sentry.io/platforms/javascript/data-management/sensitive-data/)
2. [Server-side](https://docs.sentry.io/product/data-management-settings/scrubbing/server-side-scrubbing/)
3. Relay

SDK ã§ã¯ `before-send` hook ã‚’ä½¿ã„ã€Sentry ã‚µãƒ¼ãƒã¸é€ä¿¡ã™ã‚‹å‰ã«æƒ…å ±ã‚’è½ã¨ã›ã¾ã™ã€‚JavaScript ã‚³ãƒ¼ãƒ‰ä¾‹ã¯ä»¥ä¸‹ã§ã™ (å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãã®ã¾ã¾å¼•ã£å¼µã£ã¦ããŸã‚‚ã®ã§ã™)ã€‚**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å˜ä½ã§è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

```javascript
Sentry.init({
  dsn: "https://01412c0223214e40881982929d080bcc@o120386.ingest.sentry.io/5182863",
  beforeSend(event) {
    // Modify the event here
    if (event.user) {
      // Don't send user's email address
      delete event.user.email;
    }
    return event;
  },
});
```

æ¬¡ã« Server-side ã¨ã¯ã€sentry.io ä¸Šã§å€‹äººæƒ…å ±ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ã‚‚ã®ã§ã™ã€‚**å€‹äººæƒ…å ±è‡ªä½“ã¯ã‚µãƒ¼ãƒã«é€ä¿¡ã•ã‚Œã¾ã™ãŒã€ãã‚Œã‚’ã‚¹ãƒˆã‚¢ã—ãªã„ã‚ˆã†ã«ã§ãã¾ã™**ã€‚ã“ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§ã™ã€‚Data Scrubber ã‚’æœ‰åŠ¹ã«ã™ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ password ãªã©ã®å€¤ãŒãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã¾ã™ã€‚åŠ ãˆã¦ç‹¬è‡ªã®è¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚

æœ¬é¡Œã§ã‚ã‚‹ Relay ã‚’æ´»ç”¨ã™ã‚‹ã¨ã€**ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®è¨­å®šã‚’ä¸­å¤®ç®¡ç†ã—ã¤ã¤ã€Sentry ã‚µãƒ¼ãƒã«å€‹äººæƒ…å ±ã‚’é€ä¿¡ã—ãªããªã‚Šã¾ã™**ã€‚Relay ã®å‹•ä½œãƒ¢ãƒ¼ãƒ‰ã®ã†ã¡ managed ã‚’é¸æŠã™ã‚‹ã¨ ã€Server-side ã®è¨­å®šã‚’èª­ã¿ã€Relay ä¸Šã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ãã‚Œã¾ã™ã€‚ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«ã‚ˆã£ã¦ã¯ Relay ãŒè‰¯ã„ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

## 2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã®å‰Šæ¸›
Relay ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç´ æ—©ãè¿”ã™ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ç›´æ¥ Sentry ã‚µãƒ¼ãƒã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚ˆã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé«˜é€Ÿã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ãŒé »ç¹ã«è¡Œã‚ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ”¹å–„ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## 3. åˆ¶é™ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã®ä½¿ç”¨
ä½¿ç”¨ã§ãã‚‹ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«åˆ¶é™ãŒã‚ã‚Šã€sentry.io ã‚’ç›´æ¥åˆ©ç”¨ã§ããªã„ç’°å¢ƒã§ã¯ã€ä½•ã‚‰ã‹ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ Relay ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

## 4. çµ±è¨ˆæƒ…å ±ã®ç›£è¦–
Relay ã¯ [StatsD å½¢å¼ã§æ§˜ã€…ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å‡ºåŠ›ã—ã¾ã™](https://docs.sentry.io/product/relay/monitoring/collected-metrics/)ã€‚ä¾‹ãˆã° event accepted, dropped æ•°ãªã©ãŒã‚ã‚Šã¾ã™ã€‚sentry.io ã‚’é‹ç”¨ã™ã‚‹ä¸Šã§æ°—ã‚’ã¤ã‘ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã® 1 ã¤ãŒã€æœˆé–“ã® event limit è¶…éã«ã‚ˆã‚Š event ãŒ drop ã•ã‚Œã¦ã—ã¾ã†ã“ã¨ã§ã™ã€‚Subscription ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã€ç¾åœ¨ã® event usage ã¯é–²è¦§ã§ãã¾ã™ãŒã€åˆ©ç”¨å‰²åˆãªã©ã‚’å…¥åŠ›ã«é€šçŸ¥ã¯ã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€Relay ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ä½¿ã£ã¦ã€ç›£è¦–ã‚„ã‚¢ãƒ©ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

https://github.com/prometheus/statsd_exporter ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡å…ˆã®è¨­å®šã‚’ã™ã‚Œã° Prometheus ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¸ã‚ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚Grafana ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã« event accepted æ•°ã‚’å¯è¦–åŒ–ã§ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/35088ab4c9f4902e0cb792c9.png)

# Pros/Cons

ã“ã‚Œã¾ã§ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®èª¬æ˜ã‚’ã—ã¦ãã¾ã—ãŸãŒã€å®Ÿéš›ã«å°å…¥ã™ã‚‹ã«ã‚ãŸã£ã¦ Pros/Cons ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

## Pros

### Officially Supported

å…¬å¼ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è‡ªå‰ã§ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒã‚’æ›¸ãã‚ˆã‚Šã‚‚æ©Ÿèƒ½æ‹¡å¼µã‚„å …ç‰¢æ€§ã®è¦³ç‚¹ã§è‰¯ã„ã§ã™ã€‚

### Container ready

å…¬å¼ã« [Docker ã‚¤ãƒ¡ãƒ¼ã‚¸](https://hub.docker.com/r/getsentry/relay/)ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚[Operating Guidelines](https://docs.sentry.io/product/relay/operating-guidelines/) ã§ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã‚’å¿µé ­ã«ç½®ã„ãŸè¨˜è¿°ãŒã•ã‚Œã¦ã„ã¾ã™ã€‚K8s ãªã©ã¸æ‰‹è»½ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚

### ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒä¸è¦

ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã©ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä¸è¦ãªãŸã‚ã€é‹ç”¨ã¯æ¯”è¼ƒçš„ã—ã‚„ã™ã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚

## Cons

### é‹ç”¨è² è·ã®å¢—åŠ 

å½“ç„¶ã®ã“ã¨ã§ã¯ã‚ã‚Šã¾ã™ãŒã€sentry.io ã¨ã„ã†ãƒãƒãƒ¼ã‚¸ãƒ‰ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€Relay ã¯è‡ªå‰ã§é‹ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é‹ç”¨ã—ã‚„ã™ã„ã¨ã¯ã„ãˆã€Relay è‡ªä½“ã®ç›£è¦–ã‚„ã‚¢ãƒ©ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½œã‚Šè¾¼ã‚“ã ã»ã†ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚é‹ç”¨ã«ã‚ãŸã£ã¦ã¯ [Operating Guidelines](https://docs.sentry.io/product/relay/operating-guidelines/) ã‚‚å‚è€ƒã«ãªã‚Šã¾ã™ã€‚


# K8s ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
æœ€å¾Œã«ã€K8s ã‚’å¯¾è±¡ã¨ã—ãŸå…·ä½“çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¤ã„ã¦ç°¡å˜ã«æ›¸ãã¾ã™ã€‚

[Configuration Options](https://docs.sentry.io/product/relay/options/) ã®é€šã‚Šã€è¨­å®šã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦å¼•æ•°æŒ‡å®šã«ã‚ˆã‚Šè¡Œã„ã¾ã™ã€‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ã€ä¸€éƒ¨ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æŒ‡å®šãŒå¯èƒ½ã§ã™ãŒã€ã™ã¹ã¦ã§ã¯ãªã„ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”¨æ„ãŒç„¡é›£ã§ã™ã€‚ConfigMap ã‚’å®šç¾©ã—ã¾ã™ã€‚

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sentry-relay-config
data:
  config.yml: |
    relay:
      mode: proxy
      upstream: "https://sentry.io/"
      host: 0.0.0.0
      port: 3000
      tls_port: ~
      tls_identity_path: ~
      tls_identity_password: ~
    metrics:
      statsd: 127.0.0.1:9125
      prefix: sentry.relay
    logging:
      format: json
```

Deployment ã§ã¯ config.yml ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ã‚ã’ã‚Œã°è‰¯ã„ã§ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    name: sentry-relay
    app: sentry-relay
  name: sentry-relay
spec:
  replicas: 2
  selector:
    matchLabels:
      name: sentry-relay
  template:
    metadata:
      labels:
        name: sentry-relay
        app: sentry-relay
    spec:
      containers:
      - name: app
        image: gcr.io/ubie-core/sentry-relay:21.5.1
        ports:
        - name: sentry-web
          containerPort: 3000

        # https://docs.sentry.io/product/relay/monitoring/
        readinessProbe:
          httpGet:
            path: /api/relay/healthcheck/live/
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /api/relay/healthcheck/ready/
            port: 3000
          initialDelaySeconds: 20
          periodSeconds: 10

        resources:
          requests:
            cpu: 1000m
            memory: 512M
          limits:
            cpu: 1000m
            memory: 512M

        volumeMounts:
        - name: sentry-relay-config-volume
          mountPath: /work/.relay/config.yml
          subPath: config.yml

      - name: statsd-exporter
        image: prom/statsd-exporter:v0.20.2
        args: ["--log.format=json"]
        ports:
        - name: statsd-web
          containerPort: 9102
        - name: statsd-metrics
          containerPort: 9125

      volumes:
      - name: sentry-relay-config-volume
        configMap:
          name: sentry-relay-config

```
